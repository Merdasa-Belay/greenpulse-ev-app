# Copilot Instructions

- **Stack & entrypoints**: Next.js 15 App Router with TypeScript; Root layout `app/layout.tsx` wires `ThemeProvider`, `AuthProvider`, `ConditionalNavbar`, `EnvironmentBadge`, and embeds structured data via `lib/structuredData`. Public landing at `app/page.tsx` (components under `components/landing/*`).
- **Auth model**: Custom JWT stored as `next-auth.session-token` (HTTP-only) + readable `role` cookie. Middleware in `middleware.ts` redirects unauthenticated users to `/landing` or `/sign-in`, and guards `/admin`, `/teacher`, `/student` by role. Auth pages: `/sign-in`, `/sign-up`, `/forgot-password`, `/reset-password`.
- **API auth routes**: `app/api/signup/route.ts` (hashes with bcrypt via `lib/jwt`, defaults role to `student`), `app/api/signin/route.ts` (compares hash, signs JWT with `JWT_SECRET`, sets cookies), `app/api/auth/me/route.ts` (decodes JWT from cookie), `app/api/auth/signout/route.ts` (clears cookies).
- **Client auth state**: `contexts/AuthContext.tsx` exposes `user`, `loading`, `login`, `logout`, `refreshUser`; it calls `/api/auth/me` with `credentials: 'include'` on mount. `logout()` POSTs `/api/auth/signout` then redirects to `/sign-in`.
- **Database**: Prisma + MySQL; schema in `prisma/schema.prisma` defines `user` with `user_role` enum (`student|teacher|admin`). `lib/prisma.ts` caches the client for dev hot-reload. Postinstall runs `prisma generate`.
- **Structured data**: `lib/structuredData.ts` builds/sanitizes Course JSON-LD; `app/layout.tsx` uses `buildCourseJsonLd` + `sanitizeCourseGraph`. Keep schema changes centralized there.
- **Feature flags**: `config/features.ts` reads `NEXT_PUBLIC_FEATURE_*` envs (tutorials, subscriptions, experimentalUI, newDashboard, landingV2). Use `isFeatureEnabled(flag)` for gates.
- **Environment**: Required `.env` values: `DATABASE_URL`, `JWT_SECRET`; optional `NEXT_PUBLIC_APP_URL` (defaults to prod URL), search engine verification envs, feature flags. Cookies need `JWT_SECRET` consistency across routes.
- **Build & run**: `npm run dev` for local, `npm run build`/`start` for production; migrations via `npx prisma migrate dev` (local) or `prisma migrate deploy` (prod). No lint script is defined despite README mention.
- **Styling/UI**: Tailwind v4 with Bricolage Grotesque font variable (`--font-bricolage`). Shared UI in `components/ui/*`, marketing blocks in `components/landing/*`, dashboard/nav pieces in `components/*`. Prefer existing components over new ad-hoc styling.
- **Routing quirks**: Middleware treats `/landing`, robots/sitemap, and site-verification HTML as public. Unauthed hitting `/` gets redirected to `/landing`; signed-in users visiting auth pages are redirected to `/`.
- **Data fetching**: When calling auth-protected APIs from the client, pass `credentials: 'include'` to carry cookies; me endpoint returns `{ user | null }` gracefully on invalid tokens.
- **Error handling**: API routes return JSON with status codes; keep consistent messages (`Invalid email or password.`, `Name, email, and password are required.`). On auth failure prefer 401/400; on conflicts 409.
- **Additions**: For new protected areas, update `middleware.ts` matcher logic and role checks; for new DB entities, extend `prisma/schema.prisma` and migrate before use; for new course metadata, adjust `buildCourseJsonLd`/`sanitizeCourseGraph` and the head block in `app/layout.tsx`.
